---
phase: 02-api-security-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/finanzen/account/create/route.ts
  - src/app/api/domains/create/route.ts
  - src/app/api/quests/generate/route.ts
  - src/app/api/geist/mood/route.ts
  - src/app/api/geist/stats/route.ts
  - src/app/api/profile/upload-avatar/route.ts
  - src/app/api/contacts/create/route.ts
  - src/app/api/habits/list/route.ts
  - src/app/api/habits/complete/route.ts
  - src/app/api/habits/create/route.ts
  - src/app/api/skills/xp/route.ts
autonomous: true

must_haves:
  truths:
    - "No API route returns error.message directly to clients"
    - "All 500 responses use generic 'Internal server error' message"
    - "Error details remain logged server-side via console.error"
    - "400 validation errors can still return field-specific details (not internal errors)"
  artifacts:
    - path: "src/app/api/habits/create/route.ts"
      provides: "Habit creation with sanitized error responses"
      pattern: "error: 'Internal server error'"
    - path: "src/app/api/skills/xp/route.ts"
      provides: "Skill XP with sanitized error responses"
      pattern: "error: 'Internal server error'"
    - path: "src/app/api/geist/mood/route.ts"
      provides: "Mood logging with sanitized error responses"
      pattern: "error: 'Internal server error'"
  key_links:
    - from: "All API routes"
      to: "Error response pattern"
      via: "Generic error message"
      pattern: "{ error: 'Internal server error' }"
---

<objective>
Sanitize error responses in all API routes to prevent sensitive data leakage.

Purpose: Complete SEC-10 by replacing `error.message` passthrough with generic error messages in all 500 responses. Internal errors (database errors, unexpected exceptions) should never expose details to clients.

Output: All API routes return generic "Internal server error" for 500 responses while maintaining detailed server-side logging.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-api-security-audit/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Sanitize error responses in Habits and Skills routes</name>
  <files>
    src/app/api/habits/create/route.ts
    src/app/api/habits/complete/route.ts
    src/app/api/habits/list/route.ts
    src/app/api/skills/xp/route.ts
  </files>
  <action>
    Update each route to replace error.message passthrough with generic messages.

    Pattern to find and replace:

    BEFORE (INSECURE):
    ```typescript
    return NextResponse.json({ error: error.message }, { status: 500 });
    return NextResponse.json({ error: logError.message }, { status: 500 });
    return NextResponse.json({ error: fetchError.message }, { status: 500 });
    ```

    AFTER (SECURE):
    ```typescript
    console.error('[Route Name] Error:', error);  // Keep detailed logging
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
    ```

    Specific changes:

    1. **src/app/api/habits/create/route.ts** (line ~96):
       - Find: `{ error: habitError.message }`
       - Replace: `{ error: 'Failed to create habit' }` (user-friendly but not exposing internals)
       - Ensure console.error is present before the return

    2. **src/app/api/habits/complete/route.ts** (line ~64):
       - Find: `{ error: logError.message }`
       - Replace: `{ error: 'Failed to complete habit' }`

    3. **src/app/api/habits/list/route.ts** (line ~37):
       - Find: `{ error: error.message }`
       - Replace: `{ error: 'Failed to fetch habits' }`

    4. **src/app/api/skills/xp/route.ts** (lines ~48, ~71, ~91):
       - Find: All instances of `{ error: error.message }` or `{ error: fetchError.message }`
       - Replace: `{ error: 'Failed to update skill XP' }`
       - Note: This file has 3 instances - check all catch blocks

    Key principles:
    - Keep console.error for server-side debugging
    - Return user-friendly messages that don't expose database structure
    - Distinguish between "operation failed" (500) vs "invalid input" (400)
    - 400 validation errors (from Zod) can still include field details
  </action>
  <verify>
    Run grep to confirm no error.message passthrough remains:
    `grep -r "error: error\.message\|error: .*Error\.message" src/app/api/habits/ src/app/api/skills/`
    Should return empty.
  </verify>
  <done>Habits and Skills routes return generic error messages for 500 responses</done>
</task>

<task type="auto">
  <name>Task 2: Sanitize error responses in Geist and Domain routes</name>
  <files>
    src/app/api/geist/mood/route.ts
    src/app/api/geist/stats/route.ts
    src/app/api/domains/create/route.ts
    src/app/api/finanzen/account/create/route.ts
    src/app/api/contacts/create/route.ts
  </files>
  <action>
    Apply the same error sanitization pattern:

    1. **src/app/api/geist/mood/route.ts** (lines ~49, ~160):
       - Find: `{ error: error.message }` (2 instances)
       - Replace: `{ error: 'Failed to log mood' }`

    2. **src/app/api/geist/stats/route.ts** (line ~35):
       - Find: `{ error: error.message }`
       - Replace: `{ error: 'Failed to fetch mood stats' }`

    3. **src/app/api/domains/create/route.ts** (line ~57):
       - Find: `{ error: domainError.message }`
       - Replace: `{ error: 'Failed to create domain' }`

    4. **src/app/api/finanzen/account/create/route.ts** (line ~53):
       - Find: `{ error: accountError.message }`
       - Replace: `{ error: 'Failed to create account' }`

    5. **src/app/api/contacts/create/route.ts** (line ~104):
       - Find: `{ error: contactError.message }`
       - Replace: `{ error: 'Failed to create contact' }`

    For each change:
    - Ensure console.error exists before the return statement
    - Keep the error parameter in console.error for debugging
    - Preserve the status code (usually 500)
  </action>
  <verify>
    Run grep to confirm no error.message passthrough remains:
    `grep -r "error: error\.message\|error: .*Error\.message" src/app/api/geist/ src/app/api/domains/ src/app/api/finanzen/ src/app/api/contacts/`
    Should return empty.
  </verify>
  <done>Geist, Domains, Finanzen, and Contacts routes return generic error messages</done>
</task>

<task type="auto">
  <name>Task 3: Sanitize error responses in remaining routes</name>
  <files>
    src/app/api/quests/generate/route.ts
    src/app/api/profile/upload-avatar/route.ts
  </files>
  <action>
    1. **src/app/api/quests/generate/route.ts** (line ~88):
       - Find: `{ error: error.message || 'Failed to generate quests' }`
       - Replace: `{ error: 'Failed to generate quests' }`
       - The fallback was good practice but error.message part still leaks

    2. **src/app/api/profile/upload-avatar/route.ts** (line ~81):
       - Find: `{ error: "Fehler beim Hochladen: " + uploadError.message }`
       - Replace: `{ error: 'Failed to upload avatar' }`
       - Note: German message concatenated with error - change to English generic

    Note about test routes (NOT modified):
    - src/app/api/test/mood-logs/route.ts
    - src/app/api/test/journal-entries/route.ts
    These are dev-only routes (blocked by NODE_ENV check in production).
    They can keep error.message for debugging purposes since they're never exposed in production.
    Add a comment if desired: `// Test route: error details OK since blocked in production`

    Final verification - do a comprehensive grep:
    ```bash
    grep -r "error: error\.message\|error: .*Error\.message" src/app/api/ \
      --include="*.ts" \
      | grep -v "test/" \
      | grep -v "// Test route"
    ```
    Should return empty (excluding test routes).
  </action>
  <verify>
    Full codebase check:
    `grep -rn "error\.message" src/app/api/ --include="*.ts" | grep -v "test/" | grep "status: 500"`
    Should return empty or only console.error statements.
  </verify>
  <done>All production API routes sanitize error responses</done>
</task>

</tasks>

<verification>
1. Run comprehensive grep for error.message in 500 responses:
   `grep -rn "error\.message" src/app/api/ --include="*.ts" | grep -v "test/" | grep -v "console"`
   Should show no matches in return statements

2. Verify TypeScript compiles: `npx tsc --noEmit`

3. Verify each affected route still functions:
   - API routes should still return 500 on actual errors
   - Error details logged to console, not exposed to client

4. Test one route manually (if dev server running):
   ```bash
   # This should return generic error, not database details
   curl -X POST http://localhost:3000/api/habits/create \
     -H "Content-Type: application/json" \
     -d '{"invalid": "data"}' 2>/dev/null | jq .
   ```
</verification>

<success_criteria>
- Zero instances of `error.message` in 500 response returns (excluding test routes)
- All console.error statements preserved for debugging
- User-friendly error messages that don't expose internals
- TypeScript compiles without errors
- Routes still function correctly (500 on error, 200/201 on success)
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-security-audit/02-01-SUMMARY.md`
</output>
