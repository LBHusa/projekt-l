---
phase: 02-konsequenzen-hp-death
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/data/health.ts
  - supabase/migrations/20260202_001_hp_system_schema.sql
autonomous: true

must_haves:
  truths:
    - "Application can read user's current HP and lives via getUserHealth()"
    - "New users get initialized with 100 HP, 3 lives automatically"
    - "Recent HP changes are accessible via getHealthEvents()"
    - "Death triggers XP loss (10% per faction) and notification"
  artifacts:
    - path: "src/lib/data/health.ts"
      provides: "Data access functions for health system"
      exports: ["getUserHealth", "initUserHealth", "getHealthEvents", "getHpPercentage", "isInDangerZone"]
      min_lines: 150
    - path: "supabase/migrations/20260202_001_hp_system_schema.sql"
      provides: "XP loss calculation in apply_hp_change"
      contains: "user_faction_stats.*current_xp"
  key_links:
    - from: "src/lib/data/health.ts"
      to: "supabase.from('user_health')"
      via: "createBrowserClient + RLS"
      pattern: "from\\('user_health'\\)"
    - from: "apply_hp_change death detection"
      to: "user_faction_stats XP reduction"
      via: "UPDATE with 10% XP penalty"
      pattern: "UPDATE user_faction_stats.*0\\.9"
---

<objective>
Implement data layer for health system and death flow with XP loss.

Purpose: Create the application-level interface for health data (mirroring factions.ts pattern) and enhance death detection to apply XP penalties and send notifications. This enables the rest of the app to read/display HP and creates real consequences for death.

Output: health.ts data access module with CRUD functions, and extended apply_hp_change RPC that applies XP loss and triggers death notifications.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/root/husatech/projekt-l/.planning/PROJECT.md
@/root/husatech/projekt-l/.planning/ROADMAP.md
@/root/husatech/projekt-l/.planning/STATE.md
@/root/husatech/projekt-l/.planning/phases/02-konsequenzen-hp-death/02-RESEARCH.md
@/root/husatech/projekt-l/.planning/phases/02-konsequenzen-hp-death/02-01-SUMMARY.md

# Pattern reference
@/root/husatech/projekt-l/src/lib/data/factions.ts
@/root/husatech/projekt-l/src/lib/data/streak-insurance.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Health Data Layer Module</name>
  <files>src/lib/data/health.ts</files>
  <action>
Create src/lib/data/health.ts following the established pattern from factions.ts and streak-insurance.ts.

**Structure:**
```typescript
// ============================================
// HEALTH DATA ACCESS
// Uses authenticated user from session
// ============================================

import { createBrowserClient } from '@/lib/supabase';
import { getUserIdOrCurrent } from '@/lib/auth-helper';
import type { UserHealth, HealthEvent } from '@/lib/database.types';

// ============================================
// HEALTH STATUS CRUD
// ============================================

/**
 * Get user's current health status
 * Auto-initializes if no record exists (100 HP, 3 lives)
 */
export async function getUserHealth(userId?: string): Promise<UserHealth | null> {
  const supabase = createBrowserClient();
  const resolvedUserId = await getUserIdOrCurrent(userId);

  const { data, error } = await supabase
    .from('user_health')
    .select('*')
    .eq('user_id', resolvedUserId)
    .single();

  if (error) {
    if (error.code === 'PGRST116') {
      // No record - initialize
      return initUserHealth(resolvedUserId);
    }
    console.error('Error fetching user health:', error);
    throw error;
  }

  return data;
}

/**
 * Initialize health record for new user
 * Called automatically by getUserHealth if no record exists
 */
export async function initUserHealth(userId?: string): Promise<UserHealth> {
  const supabase = createBrowserClient();
  const resolvedUserId = await getUserIdOrCurrent(userId);

  const { data, error } = await supabase
    .from('user_health')
    .insert({
      user_id: resolvedUserId,
      current_hp: 100,
      max_hp: 100,
      lives: 3,
      max_lives: 3,
      prestige_level: 0
    })
    .select()
    .single();

  if (error) {
    console.error('Error initializing user health:', error);
    throw error;
  }

  return data;
}

/**
 * Get recent health events (for activity feed/debug)
 */
export async function getHealthEvents(
  userId?: string,
  limit: number = 20
): Promise<HealthEvent[]> {
  const supabase = createBrowserClient();
  const resolvedUserId = await getUserIdOrCurrent(userId);

  const { data, error } = await supabase
    .from('health_events')
    .select('*')
    .eq('user_id', resolvedUserId)
    .order('created_at', { ascending: false })
    .limit(limit);

  if (error) {
    console.error('Error fetching health events:', error);
    throw error;
  }

  return data || [];
}

// ============================================
// HEALTH UTILITIES
// ============================================

/**
 * Calculate HP percentage (for UI bars)
 */
export function getHpPercentage(health: UserHealth): number {
  return Math.max(0, Math.min(100, (health.current_hp / health.max_hp) * 100));
}

/**
 * Check if user is in danger zone (< 20 HP)
 */
export function isInDangerZone(health: UserHealth): boolean {
  return getHpPercentage(health) < 20;
}

/**
 * Get HP status level for UI theming
 */
export function getHpStatus(
  health: UserHealth
): 'flourishing' | 'normal' | 'struggling' | 'danger' {
  const percentage = getHpPercentage(health);

  if (percentage >= 80) return 'flourishing';
  if (percentage >= 50) return 'normal';
  if (percentage >= 20) return 'struggling';
  return 'danger';
}
```

Follow existing patterns: getUserIdOrCurrent for auth, PGRST116 error handling for missing records, consistent error logging.
  </action>
  <verify>
```bash
# TypeScript compilation
cd /root/husatech/projekt-l
npm run build 2>&1 | grep -E "(error|Error)" && echo "BUILD FAILED" || echo "BUILD SUCCESS"

# Test import
node -e "import('./src/lib/data/health.js').then(m => console.log('Exports:', Object.keys(m)))"
```
  </verify>
  <done>
- health.ts exports getUserHealth, initUserHealth, getHealthEvents, getHpPercentage, isInDangerZone, getHpStatus
- No TypeScript compilation errors
- Auto-initialization works (getUserHealth creates record if missing)
- Functions match factions.ts style (getUserIdOrCurrent, error handling)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Death Flow with XP Loss to apply_hp_change</name>
  <files>supabase/migrations/20260202_001_hp_system_schema.sql</files>
  <action>
Extend the apply_hp_change RPC function to apply XP loss and send death notifications.

**Update apply_hp_change function to add after death detection:**

When death occurs (current_hp > 0 AND new_hp = 0):
1. Apply 10% XP loss to all factions:
```sql
UPDATE user_faction_stats
SET current_xp = FLOOR(current_xp * 0.9)
WHERE user_id = p_user_id;
```

2. Insert death notification using existing notifications pattern:
```sql
INSERT INTO notifications (
  user_id,
  type,
  title,
  message,
  data,
  read
) VALUES (
  p_user_id,
  'system',
  'Du bist gestorben',
  format('Dein Avatar ist auf 0 HP gefallen. Du hast ein Leben verloren (%s/3 verbleibend) und 10%% XP in allen Factions.', GREATEST(0, v_lives - 1)),
  jsonb_build_object('event', 'death', 'lives_remaining', GREATEST(0, v_lives - 1)),
  false
);
```

**Death flow sequence:**
1. Lock user_health row
2. Calculate new HP
3. Detect death (HP dropped to 0)
4. Apply 10% XP penalty to all factions
5. Respawn at full HP, decrement lives
6. Insert death event into health_events
7. Insert notification

Use EXCEPTION block to ensure transaction rollback if any step fails.

Location: Modify existing apply_hp_change function in same migration file from 02-01-PLAN.md.
  </action>
  <verify>
```bash
# Re-apply migration
cd /root/husatech/projekt-l
npx supabase db reset --local

# Test death flow with XP loss
npx supabase db query "
DO \$\$
DECLARE
  test_user_id UUID := gen_random_uuid();
BEGIN
  -- Setup: User with HP and XP
  INSERT INTO user_health (user_id, current_hp, lives) VALUES (test_user_id, 10, 3);
  INSERT INTO user_faction_stats (user_id, faction_id, current_xp) VALUES (test_user_id, 'koerper', 1000);

  -- Kill user
  PERFORM apply_hp_change(test_user_id, -20);

  -- Verify XP loss
  ASSERT (SELECT current_xp FROM user_faction_stats WHERE user_id = test_user_id) = 900, 'XP should be reduced by 10%';

  -- Verify notification
  ASSERT (SELECT COUNT(*) FROM notifications WHERE user_id = test_user_id AND type = 'system' AND title LIKE '%gestorben%') = 1, 'Death notification created';
END \$\$;
"
```
  </verify>
  <done>
- apply_hp_change RPC applies 10% XP loss on death
- Death notification inserted into notifications table
- Transaction rolls back if any step fails
- HP respawn + life loss still works
  </done>
</task>

</tasks>

<verification>
**Data layer functionality:**
```typescript
import { getUserHealth, initUserHealth, getHealthEvents, getHpPercentage, isInDangerZone } from '@/lib/data/health';

// Test getUserHealth auto-initialization
const health = await getUserHealth();
console.log('HP:', health.current_hp, 'Lives:', health.lives);

// Test utility functions
console.log('HP Percentage:', getHpPercentage(health));
console.log('Danger Zone:', isInDangerZone(health));

// Test event history
const events = await getHealthEvents();
console.log('Recent events:', events.length);
```

**Death flow verification:**
```sql
-- Simulate death and check consequences
DO $$
DECLARE
  test_user_id UUID := gen_random_uuid();
  initial_xp INTEGER;
  final_xp INTEGER;
BEGIN
  -- Setup
  INSERT INTO user_health (user_id, current_hp, lives) VALUES (test_user_id, 15, 3);
  INSERT INTO user_faction_stats (user_id, faction_id, current_xp)
  VALUES (test_user_id, 'koerper', 5000);

  SELECT current_xp INTO initial_xp FROM user_faction_stats WHERE user_id = test_user_id;

  -- Trigger death
  PERFORM apply_hp_change(test_user_id, -30);

  SELECT current_xp INTO final_xp FROM user_faction_stats WHERE user_id = test_user_id;

  -- Verify
  ASSERT final_xp = initial_xp * 0.9, format('XP loss failed: %s -> %s', initial_xp, final_xp);
  ASSERT (SELECT lives FROM user_health WHERE user_id = test_user_id) = 2, 'Lives not decremented';
  ASSERT (SELECT COUNT(*) FROM notifications WHERE user_id = test_user_id) = 1, 'No death notification';
END $$;
```
</verification>

<success_criteria>
**Must be true after completion:**
- [ ] getUserHealth() returns UserHealth or auto-initializes
- [ ] getHealthEvents() returns recent HP changes
- [ ] Utility functions (getHpPercentage, isInDangerZone) work
- [ ] Death triggers 10% XP loss across all factions
- [ ] Death notification appears in notifications table
- [ ] Transaction rollback works if any death step fails
- [ ] No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-konsequenzen-hp-death/02-02-SUMMARY.md`
</output>
