---
phase: 02-konsequenzen-hp-death
plan: 04
type: execute
wave: 3
depends_on: ["02-01"]
files_modified:
  - supabase/migrations/20260202_003_hp_heal_triggers.sql
autonomous: true

must_haves:
  truths:
    - "Quest completion heals HP based on difficulty (easy: +10, medium: +15, hard: +25, epic: +40)"
    - "Positive habit completion heals +5 HP automatically"
    - "Mood logging heals +2 HP automatically"
  artifacts:
    - path: "supabase/migrations/20260202_003_hp_heal_triggers.sql"
      provides: "Three PostgreSQL triggers for automatic HP healing"
      contains: "quest_completion_hp_trigger"
      contains: "habit_completion_hp_trigger"
      contains: "mood_log_hp_trigger"
  key_links:
    - from: "quests.status UPDATE to 'completed'"
      to: "apply_hp_change(+10 to +40)"
      via: "AFTER trigger with difficulty-based HP"
      pattern: "handle_quest_completion_hp"
    - from: "habit_logs INSERT"
      to: "apply_hp_change(+5)"
      via: "AFTER trigger"
      pattern: "handle_habit_completion_hp"
    - from: "mood_logs INSERT"
      to: "apply_hp_change(+2)"
      via: "AFTER trigger"
      pattern: "handle_mood_log_hp"
---

<objective>
Implement all HP heal triggers that reward user for positive actions.

Purpose: Balance the damage system with healing rewards. Users gain HP from completing quests, logging habits, and tracking mood. This creates the positive reinforcement loop that makes the HP system feel fair and motivating.

Output: Single migration file with three PostgreSQL triggers that automatically grant HP on quest completion, habit logging, and mood tracking.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/root/husatech/projekt-l/.planning/PROJECT.md
@/root/husatech/projekt-l/.planning/ROADMAP.md
@/root/husatech/projekt-l/.planning/STATE.md
@/root/husatech/projekt-l/.planning/phases/02-konsequenzen-hp-death/02-RESEARCH.md
@/root/husatech/projekt-l/.planning/phases/02-konsequenzen-hp-death/02-01-SUMMARY.md

# Pattern reference
@/root/husatech/projekt-l/supabase/migrations/20260202_002_hp_damage_triggers.sql (from 02-03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Quest Completion Heal Trigger</name>
  <files>supabase/migrations/20260202_003_hp_heal_triggers.sql</files>
  <action>
Create new migration file for all heal triggers (grouped together for semantic clarity).

**Quest Completion Trigger:**
```sql
-- ============================================
-- HP HEAL TRIGGERS
-- Grant HP for positive user actions
-- ============================================

-- Trigger function for quest completion HP heal
CREATE OR REPLACE FUNCTION handle_quest_completion_hp()
RETURNS TRIGGER AS $$
DECLARE
  v_hp_reward INTEGER;
BEGIN
  -- Only trigger on status change to 'completed'
  IF NEW.status = 'completed' AND (OLD.status IS NULL OR OLD.status != 'completed') THEN
    -- HP reward based on difficulty
    v_hp_reward := CASE NEW.difficulty
      WHEN 'easy' THEN 10
      WHEN 'medium' THEN 15
      WHEN 'hard' THEN 25
      WHEN 'epic' THEN 40
      ELSE 15 -- Default for unknown difficulty
    END;

    -- Log heal event
    INSERT INTO health_events (
      user_id,
      event_type,
      hp_change,
      source_table,
      source_id,
      metadata
    ) VALUES (
      NEW.user_id,
      'quest_complete',
      v_hp_reward,
      'quests',
      NEW.id,
      jsonb_build_object('difficulty', NEW.difficulty, 'title', NEW.title)
    );

    -- Apply HP heal
    PERFORM apply_hp_change(NEW.user_id, v_hp_reward);
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger on quests table
CREATE TRIGGER quest_completion_hp_trigger
AFTER UPDATE ON quests
FOR EACH ROW
EXECUTE FUNCTION handle_quest_completion_hp();
```

**Key considerations:**
- Only heal on NEW.status = 'completed' AND OLD.status != 'completed'
- Variable HP based on difficulty (easy: 10, medium: 15, hard: 25, epic: 40)
- Log event with metadata for quest title and difficulty
- Use DECLARE block for v_hp_reward variable
  </action>
  <verify>
```bash
# Apply migration
cd /root/husatech/projekt-l
npx supabase db reset --local

# Test quest completion heal
npx supabase db query "
DO \$\$
DECLARE
  test_user_id UUID := gen_random_uuid();
  test_quest_id UUID := gen_random_uuid();
BEGIN
  -- Setup
  INSERT INTO user_health (user_id, current_hp, max_hp) VALUES (test_user_id, 50, 100);
  INSERT INTO quests (id, user_id, title, difficulty, status) VALUES (test_quest_id, test_user_id, 'Hard Quest', 'hard', 'active');

  -- Complete quest
  UPDATE quests SET status = 'completed' WHERE id = test_quest_id;

  -- Verify heal (50 + 25 = 75)
  ASSERT (SELECT current_hp FROM user_health WHERE user_id = test_user_id) = 75, 'HP should increase by 25 for hard quest';
  ASSERT (SELECT COUNT(*) FROM health_events WHERE user_id = test_user_id AND event_type = 'quest_complete') = 1, 'Heal event logged';
END \$\$;
"
```
  </verify>
  <done>
- Quest completion trigger created
- HP reward varies by difficulty (10/15/25/40)
- Only triggers on status change to 'completed'
- health_events logs quest_complete event with metadata
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Habit Completion Heal Trigger</name>
  <files>supabase/migrations/20260202_003_hp_heal_triggers.sql</files>
  <action>
Add habit completion trigger to same migration file (after quest completion trigger).

**Habit Completion Trigger:**
```sql
-- Trigger function for habit completion HP heal
CREATE OR REPLACE FUNCTION handle_habit_completion_hp()
RETURNS TRIGGER AS $$
DECLARE
  v_habit RECORD;
BEGIN
  -- Get habit details to check if it's positive habit
  SELECT type INTO v_habit FROM habits WHERE id = NEW.habit_id;

  -- Only heal for positive habits (not negative habit avoidance)
  IF v_habit.type = 'positive' THEN
    -- Log heal event
    INSERT INTO health_events (
      user_id,
      event_type,
      hp_change,
      source_table,
      source_id,
      metadata
    ) VALUES (
      NEW.user_id,
      'habit_done',
      5,
      'habit_logs',
      NEW.id,
      jsonb_build_object('habit_id', NEW.habit_id, 'logged_at', NEW.logged_at)
    );

    -- Apply HP heal
    PERFORM apply_hp_change(NEW.user_id, 5);
  END IF;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger on habit_logs table
CREATE TRIGGER habit_completion_hp_trigger
AFTER INSERT ON habit_logs
FOR EACH ROW
EXECUTE FUNCTION handle_habit_completion_hp();
```

**Key considerations:**
- Only heal for positive habits (type = 'positive')
- Flat +5 HP per habit completion
- Trigger fires on INSERT (new habit log)
- Check habits table for habit type (requires JOIN in trigger)

**Performance note:** This trigger fires frequently (50+ times per day per active user). Keep logic simple - just check habit type and apply heal, no complex calculations.
  </action>
  <verify>
```bash
# Test habit completion heal
npx supabase db query "
DO \$\$
DECLARE
  test_user_id UUID := gen_random_uuid();
  test_habit_id UUID := gen_random_uuid();
BEGIN
  -- Setup
  INSERT INTO user_health (user_id, current_hp, max_hp) VALUES (test_user_id, 50, 100);
  INSERT INTO habits (id, user_id, name, type, faction_id) VALUES (test_habit_id, test_user_id, 'Morning Run', 'positive', 'koerper');

  -- Log habit
  INSERT INTO habit_logs (user_id, habit_id, logged_at) VALUES (test_user_id, test_habit_id, NOW());

  -- Verify heal (50 + 5 = 55)
  ASSERT (SELECT current_hp FROM user_health WHERE user_id = test_user_id) = 55, 'HP should increase by 5';
  ASSERT (SELECT COUNT(*) FROM health_events WHERE user_id = test_user_id AND event_type = 'habit_done') = 1, 'Heal event logged';
END \$\$;
"
```
  </verify>
  <done>
- Habit completion trigger created
- Only heals for positive habits (+5 HP)
- Trigger fires on habit_logs INSERT
- health_events logs habit_done event
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Mood Log Heal Trigger</name>
  <files>supabase/migrations/20260202_003_hp_heal_triggers.sql</files>
  <action>
Add mood log trigger to same migration file (after habit completion trigger).

**Mood Log Trigger:**
```sql
-- Trigger function for mood log HP heal
CREATE OR REPLACE FUNCTION handle_mood_log_hp()
RETURNS TRIGGER AS $$
BEGIN
  -- Log heal event
  INSERT INTO health_events (
    user_id,
    event_type,
    hp_change,
    source_table,
    source_id,
    metadata
  ) VALUES (
    NEW.user_id,
    'mood_log',
    2,
    'mood_logs',
    NEW.id,
    jsonb_build_object('mood', NEW.mood, 'logged_at', NEW.logged_at)
  );

  -- Apply HP heal
  PERFORM apply_hp_change(NEW.user_id, 2);

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger on mood_logs table
CREATE TRIGGER mood_log_hp_trigger
AFTER INSERT ON mood_logs
FOR EACH ROW
EXECUTE FUNCTION handle_mood_log_hp();
```

**Key considerations:**
- Small heal (+2 HP) to encourage daily mood tracking
- Trigger fires on INSERT (new mood log)
- No conditions - any mood log heals
- Store mood value in metadata for analytics

**Rationale:** Mood tracking is the simplest positive action, so small reward. Encourages daily check-in without being exploitable (one mood log per day typically).
  </action>
  <verify>
```bash
# Test mood log heal
npx supabase db query "
DO \$\$
DECLARE
  test_user_id UUID := gen_random_uuid();
BEGIN
  -- Setup
  INSERT INTO user_health (user_id, current_hp, max_hp) VALUES (test_user_id, 50, 100);

  -- Log mood
  INSERT INTO mood_logs (user_id, mood, logged_at) VALUES (test_user_id, 7, NOW());

  -- Verify heal (50 + 2 = 52)
  ASSERT (SELECT current_hp FROM user_health WHERE user_id = test_user_id) = 52, 'HP should increase by 2';
  ASSERT (SELECT COUNT(*) FROM health_events WHERE user_id = test_user_id AND event_type = 'mood_log') = 1, 'Heal event logged';
END \$\$;
"
```
  </verify>
  <done>
- Mood log trigger created
- +2 HP per mood log
- Trigger fires on mood_logs INSERT
- health_events logs mood_log event with mood value
  </done>
</task>

</tasks>

<verification>
**Verify all three triggers exist:**
```sql
SELECT trigger_name, event_object_table
FROM information_schema.triggers
WHERE trigger_name IN (
  'quest_completion_hp_trigger',
  'habit_completion_hp_trigger',
  'mood_log_hp_trigger'
);
```

**Test full heal flow:**
```sql
DO $$
DECLARE
  test_user_id UUID := gen_random_uuid();
  test_quest_id UUID := gen_random_uuid();
  test_habit_id UUID := gen_random_uuid();
  initial_hp INTEGER;
  final_hp INTEGER;
BEGIN
  -- Setup: User at 30 HP
  INSERT INTO user_health (user_id, current_hp, max_hp) VALUES (test_user_id, 30, 100);
  INSERT INTO quests (id, user_id, title, difficulty, status) VALUES (test_quest_id, test_user_id, 'Test', 'medium', 'active');
  INSERT INTO habits (id, user_id, name, type, faction_id) VALUES (test_habit_id, test_user_id, 'Test Habit', 'positive', 'koerper');

  SELECT current_hp INTO initial_hp FROM user_health WHERE user_id = test_user_id;

  -- Complete quest (+15), log habit (+5), log mood (+2)
  UPDATE quests SET status = 'completed' WHERE id = test_quest_id;
  INSERT INTO habit_logs (user_id, habit_id, logged_at) VALUES (test_user_id, test_habit_id, NOW());
  INSERT INTO mood_logs (user_id, mood, logged_at) VALUES (test_user_id, 7, NOW());

  SELECT current_hp INTO final_hp FROM user_health WHERE user_id = test_user_id;

  -- Verify total heal: 30 + 15 + 5 + 2 = 52
  ASSERT final_hp = 52, format('Expected 52 HP, got %s', final_hp);

  -- Verify events logged
  ASSERT (SELECT COUNT(*) FROM health_events WHERE user_id = test_user_id) = 3, 'Should have 3 heal events';
END $$;
```

**Check HP cap enforcement:**
```sql
-- User at 95 HP, complete epic quest (+40)
-- Should cap at 100, not overflow to 135
DO $$
DECLARE
  test_user_id UUID := gen_random_uuid();
  test_quest_id UUID := gen_random_uuid();
BEGIN
  INSERT INTO user_health (user_id, current_hp, max_hp) VALUES (test_user_id, 95, 100);
  INSERT INTO quests (id, user_id, title, difficulty, status) VALUES (test_quest_id, test_user_id, 'Epic Quest', 'epic', 'active');

  UPDATE quests SET status = 'completed' WHERE id = test_quest_id;

  ASSERT (SELECT current_hp FROM user_health WHERE user_id = test_user_id) = 100, 'HP should cap at max_hp';
END $$;
```
</verification>

<success_criteria>
**Must be true after completion:**
- [ ] Quest completion heals based on difficulty (10/15/25/40 HP)
- [ ] Positive habit completion heals +5 HP
- [ ] Mood logging heals +2 HP
- [ ] All heal events logged to health_events
- [ ] HP caps at max_hp (no overflow)
- [ ] Triggers only fire once per status change
- [ ] No duplicate healing on repeated INSERTs/UPDATEs
</success_criteria>

<output>
After completion, create `.planning/phases/02-konsequenzen-hp-death/02-04-SUMMARY.md`
</output>
