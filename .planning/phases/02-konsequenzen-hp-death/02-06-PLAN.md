---
phase: 02-konsequenzen-hp-death
plan: 06
type: execute
wave: 4
depends_on: ["02-02", "02-05"]
files_modified:
  - src/components/health/PrestigeModal.tsx
  - src/app/api/health/prestige/route.ts
  - src/components/health/DangerZoneAlert.tsx
  - src/app/dashboard/page.tsx
autonomous: false

must_haves:
  truths:
    - "User at 0 lives sees Prestige modal explaining soft reset"
    - "Prestige is user-initiated (requires confirmation)"
    - "Prestige resets lives to 3, grants Phoenix badge, applies -10% XP"
    - "Danger zone alert appears when HP < 20"
    - "All HP system features work end-to-end"
  artifacts:
    - path: "src/components/health/PrestigeModal.tsx"
      provides: "Prestige explanation and confirmation UI"
      exports: ["default"]
      min_lines: 150
    - path: "src/app/api/health/prestige/route.ts"
      provides: "Prestige API endpoint"
      exports: ["POST"]
    - path: "src/components/health/DangerZoneAlert.tsx"
      provides: "Warning UI for low HP"
      exports: ["default"]
    - path: "src/app/dashboard/page.tsx"
      provides: "DangerZoneAlert integration"
      contains: "DangerZoneAlert"
  key_links:
    - from: "PrestigeModal confirmation"
      to: "/api/health/prestige"
      via: "POST request with userId"
      pattern: "fetch.*health/prestige"
    - from: "/api/health/prestige"
      to: "user_health.awaiting_prestige"
      via: "Reset to false, lives to 3, prestige_level +1"
      pattern: "awaiting_prestige.*false"
    - from: "DangerZoneAlert"
      to: "isInDangerZone(health)"
      via: "Show if HP < 20"
      pattern: "isInDangerZone"
---

<objective>
Implement Prestige system for fair death recovery and Danger Zone warnings for low HP.

Purpose: Complete the HP system with a soft reset mechanism (Prestige) that prevents total frustration at 0 lives, and proactive warnings (Danger Zone) that alert users before death. This balances the "stakes" with fairness and empathy.

Output: Prestige modal with user confirmation, API endpoint for prestige reset, danger zone alert component, and human verification of full HP system.
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/root/husatech/projekt-l/.planning/PROJECT.md
@/root/husatech/projekt-l/.planning/ROADMAP.md
@/root/husatech/projekt-l/.planning/STATE.md
@/root/husatech/projekt-l/.planning/phases/02-konsequenzen-hp-death/02-RESEARCH.md
@/root/husatech/projekt-l/.planning/phases/02-konsequenzen-hp-death/02-01-SUMMARY.md
@/root/husatech/projekt-l/.planning/phases/02-konsequenzen-hp-death/02-02-SUMMARY.md
@/root/husatech/projekt-l/.planning/phases/02-konsequenzen-hp-death/02-05-SUMMARY.md

# Pattern references
@/root/husatech/projekt-l/src/components/Modal.tsx
@/root/husatech/projekt-l/src/lib/data/health.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Prestige Modal Component</name>
  <files>src/components/health/PrestigeModal.tsx</files>
  <action>
Create modal that appears when user hits 0 lives, explaining prestige and requiring confirmation.

**Component structure:**
```typescript
'use client';

import { useState } from 'react';
import Modal from '@/components/Modal';
import { Phoenix, AlertCircle, TrendingDown, Award } from 'lucide-react';

interface PrestigeModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => Promise<void>;
  currentPrestigeLevel: number;
}

export default function PrestigeModal({
  isOpen,
  onClose,
  currentPrestigeLevel,
  onConfirm
}: PrestigeModalProps) {
  const [isProcessing, setIsProcessing] = useState(false);

  const handleConfirm = async () => {
    setIsProcessing(true);
    try {
      await onConfirm();
    } catch (error) {
      console.error('Prestige failed:', error);
      alert('Prestige fehlgeschlagen. Bitte versuche es erneut.');
    } finally {
      setIsProcessing(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={() => {}} size="lg">
      <div className="space-y-6">
        {/* Header */}
        <div className="text-center space-y-2">
          <Phoenix className="w-16 h-16 text-orange-500 mx-auto animate-pulse" />
          <h2 className="text-2xl font-bold">Phoenix-Prestige</h2>
          <p className="text-gray-400">
            Du hast alle Leben verloren. Zeit f√ºr einen Neuanfang.
          </p>
        </div>

        {/* Explanation */}
        <div className="bg-gray-800 rounded-lg p-4 space-y-4">
          <div className="flex items-start gap-3">
            <AlertCircle className="w-5 h-5 text-yellow-500 mt-0.5" />
            <div>
              <h3 className="font-semibold text-sm">Was passiert beim Prestige?</h3>
              <p className="text-sm text-gray-400 mt-1">
                Du erh√§ltst 3 neue Leben und 100 HP. Dein Avatar wird wiedergeboren.
              </p>
            </div>
          </div>

          <div className="flex items-start gap-3">
            <TrendingDown className="w-5 h-5 text-red-500 mt-0.5" />
            <div>
              <h3 className="font-semibold text-sm">Konsequenzen</h3>
              <p className="text-sm text-gray-400 mt-1">
                Du verlierst <strong className="text-red-400">10% XP in allen Factions</strong>.
                Das ist sp√ºrbar, aber du kannst dich davon erholen.
              </p>
            </div>
          </div>

          <div className="flex items-start gap-3">
            <Award className="w-5 h-5 text-purple-500 mt-0.5" />
            <div>
              <h3 className="font-semibold text-sm">Belohnungen</h3>
              <p className="text-sm text-gray-400 mt-1">
                Du erh√§ltst das <strong className="text-purple-400">Phoenix Badge (Prestige {currentPrestigeLevel + 1})</strong> als
                Zeichen deiner Widerstandsf√§higkeit.
              </p>
            </div>
          </div>
        </div>

        {/* Warning */}
        <div className="bg-orange-900/20 border border-orange-500/30 rounded-lg p-3">
          <p className="text-sm text-orange-300 text-center">
            Diese Entscheidung ist endg√ºltig. √úberlege gut, ob du bereit bist.
          </p>
        </div>

        {/* Actions */}
        <div className="flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 px-4 py-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium transition-colors"
            disabled={isProcessing}
          >
            Noch nicht bereit
          </button>
          <button
            onClick={handleConfirm}
            disabled={isProcessing}
            className="flex-1 px-4 py-3 bg-orange-600 hover:bg-orange-500 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isProcessing ? 'Wiedergeburt...' : 'Phoenix-Prestige akzeptieren'}
          </button>
        </div>
      </div>
    </Modal>
  );
}
```

**Key features:**
- Phoenix icon with pulse animation
- Clear explanation of prestige mechanics
- Visual indicators (icons) for each section
- Warning about permanence
- Disabled state during processing
- No easy close (must click button)

**Styling:** Dark theme, orange/purple accents for phoenix theme, prominent warning.
  </action>
  <verify>
```bash
# TypeScript compilation
cd /root/husatech/projekt-l
npm run build 2>&1 | grep -E "(error|Error)" && echo "BUILD FAILED" || echo "BUILD SUCCESS"
```
  </verify>
  <done>
- PrestigeModal component created
- Explains prestige mechanics clearly
- Requires explicit user confirmation
- Shows consequences (XP loss) and rewards (badge)
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Prestige API Endpoint</name>
  <files>src/app/api/health/prestige/route.ts</files>
  <action>
Create API endpoint to handle prestige reset when user confirms.

**Endpoint structure:**
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase-server';
import { createAdminClient } from '@/lib/supabase-admin';

export async function POST(request: NextRequest) {
  const supabase = await createClient();
  const adminClient = createAdminClient();

  try {
    // Get authenticated user
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Get user's health record
    const { data: health, error: healthError } = await adminClient
      .from('user_health')
      .select('*')
      .eq('user_id', user.id)
      .single();

    if (healthError || !health) {
      return NextResponse.json({ error: 'Health record not found' }, { status: 404 });
    }

    // Verify user is at 0 lives and awaiting prestige
    if (health.lives > 0 || !health.awaiting_prestige) {
      return NextResponse.json(
        { error: 'Prestige not available (must be at 0 lives)' },
        { status: 400 }
      );
    }

    // Apply prestige reset
    const newPrestigeLevel = health.prestige_level + 1;

    // Reset lives and HP
    const { error: resetError } = await adminClient
      .from('user_health')
      .update({
        lives: 3,
        current_hp: 100,
        awaiting_prestige: false,
        prestige_level: newPrestigeLevel,
        updated_at: new Date().toISOString()
      })
      .eq('user_id', user.id);

    if (resetError) {
      console.error('Failed to reset health:', resetError);
      return NextResponse.json({ error: 'Prestige reset failed' }, { status: 500 });
    }

    // Apply 10% XP penalty to all factions
    const { error: xpError } = await adminClient
      .from('user_faction_stats')
      .update({
        current_xp: adminClient.raw('FLOOR(current_xp * 0.9)')
      })
      .eq('user_id', user.id);

    if (xpError) {
      console.error('Failed to apply XP penalty:', xpError);
      // Don't fail the prestige, just log error
    }

    // Log prestige event
    await adminClient.from('health_events').insert({
      user_id: user.id,
      event_type: 'prestige',
      hp_change: 0,
      metadata: {
        prestige_level: newPrestigeLevel,
        lives_restored: 3
      }
    });

    // Grant Phoenix achievement badge
    await adminClient.from('achievements').insert({
      user_id: user.id,
      title: `Phoenix Prestige ${newPrestigeLevel}`,
      description: 'Wiedergeboren aus der Asche',
      badge_icon: 'üî•',
      earned_at: new Date().toISOString()
    });

    // Send notification
    await adminClient.from('notifications').insert({
      user_id: user.id,
      type: 'achievement',
      title: 'Phoenix-Prestige abgeschlossen',
      message: `Du wurdest als Prestige ${newPrestigeLevel} wiedergeboren. 3 Leben wiederhergestellt.`,
      data: { prestige_level: newPrestigeLevel },
      read: false
    });

    return NextResponse.json({
      success: true,
      prestige_level: newPrestigeLevel,
      lives: 3,
      current_hp: 100
    });
  } catch (error) {
    console.error('Prestige error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}
```

**Key operations:**
1. Verify user is at 0 lives and awaiting_prestige = true
2. Reset lives to 3, HP to 100, awaiting_prestige to false
3. Increment prestige_level
4. Apply 10% XP penalty to all factions
5. Log prestige event
6. Grant Phoenix achievement badge
7. Send notification

**Security:** Use createAdminClient for multi-table transaction, verify auth with createClient.
  </action>
  <verify>
```bash
# Test prestige endpoint
cd /root/husatech/projekt-l
npm run dev &
sleep 5

# Simulate prestige (requires authenticated user at 0 lives)
curl -X POST http://localhost:3000/api/health/prestige \
  -H "Content-Type: application/json" \
  -H "Cookie: sb-access-token=YOUR_TOKEN"

# Expected: {"success": true, "prestige_level": 1, "lives": 3, "current_hp": 100}
```
  </verify>
  <done>
- /api/health/prestige endpoint created
- Verifies user is at 0 lives before prestige
- Resets lives to 3, HP to 100
- Applies 10% XP penalty
- Grants Phoenix achievement badge
- Sends notification
  </done>
</task>

<task type="auto">
  <name>Task 3: Create DangerZoneAlert Component</name>
  <files>
    src/components/health/DangerZoneAlert.tsx
    src/app/dashboard/page.tsx
  </files>
  <action>
**1. Create DangerZoneAlert component:**

File: src/components/health/DangerZoneAlert.tsx
```typescript
'use client';

import { AlertTriangle, Heart, TrendingUp } from 'lucide-react';
import { motion } from 'framer-motion';
import type { UserHealth } from '@/lib/database.types';
import { isInDangerZone } from '@/lib/data/health';

interface DangerZoneAlertProps {
  health: UserHealth;
}

export default function DangerZoneAlert({ health }: DangerZoneAlertProps) {
  if (!isInDangerZone(health)) {
    return null;
  }

  const hpPercentage = (health.current_hp / health.max_hp) * 100;

  return (
    <motion.div
      initial={{ opacity: 0, y: -20 }}
      animate={{ opacity: 1, y: 0 }}
      className="max-w-2xl mx-auto"
    >
      <div className="bg-red-900/30 border-2 border-red-500 rounded-lg p-4 space-y-3">
        {/* Header */}
        <div className="flex items-center gap-3">
          <AlertTriangle className="w-6 h-6 text-red-400 animate-pulse" />
          <div>
            <h3 className="font-bold text-red-400">Kritischer HP-Stand!</h3>
            <p className="text-sm text-red-300">
              Dein Avatar ist in Gefahr ({Math.round(hpPercentage)}% HP)
            </p>
          </div>
        </div>

        {/* Advice */}
        <div className="bg-red-950/50 rounded p-3 space-y-2">
          <p className="text-sm text-gray-300 flex items-start gap-2">
            <Heart className="w-4 h-4 text-red-400 mt-0.5" />
            <span>
              <strong>So stellst du HP wieder her:</strong> Quests abschlie√üen (+15 HP),
              Habits tracken (+5 HP), Mood loggen (+2 HP)
            </span>
          </p>
          <p className="text-sm text-gray-300 flex items-start gap-2">
            <TrendingUp className="w-4 h-4 text-orange-400 mt-0.5" />
            <span>
              <strong>Vermeide Schaden:</strong> Keine Quests scheitern lassen (-10 HP),
              Streaks halten (-5 HP bei Break)
            </span>
          </p>
        </div>

        {/* Lives warning */}
        {health.lives <= 1 && (
          <div className="bg-orange-900/30 border border-orange-500/30 rounded p-2">
            <p className="text-sm text-orange-300 text-center">
              ‚ö†Ô∏è Nur noch {health.lives} Leben √ºbrig! Bei 0 HP verlierst du ein Leben.
            </p>
          </div>
        )}
      </div>
    </motion.div>
  );
}
```

**2. Integrate into dashboard:**

File: src/app/dashboard/page.tsx

Add after HealthBar, before faction stats:
```typescript
import DangerZoneAlert from '@/components/health/DangerZoneAlert';

// ... inside component ...

{/* Health status */}
<div className="max-w-md mx-auto mt-6">
  <HealthBar showDetails showLives />
</div>

{/* NEW: Danger Zone Alert */}
{health && <DangerZoneAlert health={health} />}
```

**Conditional rendering:** Only shows if isInDangerZone(health) returns true (HP < 20%).

**Styling:** Red theme, prominent border, pulsing icon, actionable advice.
  </action>
  <verify>
```bash
# TypeScript compilation
cd /root/husatech/projekt-l
npm run build

# Visual test: Set HP to 15 and check dashboard
npx supabase db query "UPDATE user_health SET current_hp = 15 WHERE user_id = 'YOUR_USER_ID';"
# Visit http://localhost:3000/dashboard
# Expected: Red danger zone alert appears
```
  </verify>
  <done>
- DangerZoneAlert component created
- Only renders when HP < 20
- Shows actionable advice (how to heal, avoid damage)
- Integrated into dashboard below HealthBar
- Animates in with Framer Motion
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete HP/Death system including:
- Database schema (user_health, health_events)
- Data layer functions (getUserHealth, getHealthEvents, etc.)
- Damage triggers (quest fail, streak break, inactivity)
- Heal triggers (quest complete, habit done, mood log)
- Death flow with XP loss and notifications
- Prestige system with user confirmation
- HealthBar UI with animation
- DangerZoneAlert for low HP warnings
  </what-built>
  <how-to-verify>
**Test full HP system flow:**

1. **Navigate to dashboard:**
   - Visit http://localhost:3000/dashboard
   - Verify HealthBar is visible showing 100 HP, 3 lives

2. **Test damage triggers:**
   ```bash
   # Create and fail a quest
   # Expected: HP drops by 10 (100 -> 90)

   # Break a habit streak via /api/habits/relapse
   # Expected: HP drops by 5 (90 -> 85)
   ```

3. **Test heal triggers:**
   ```bash
   # Complete a quest
   # Expected: HP increases by 15 (85 -> 100, capped at max)

   # Log a habit
   # Expected: HP increases by 5

   # Log mood
   # Expected: HP increases by 2
   ```

4. **Test death flow:**
   ```bash
   # Set HP to 5
   npx supabase db query "UPDATE user_health SET current_hp = 5;"

   # Fail a quest (damage -10)
   # Expected:
   # - HP resets to 100 (respawn)
   # - Lives drops to 2
   # - Death notification appears
   # - All faction XP reduced by 10%
   ```

5. **Test danger zone:**
   ```bash
   # Set HP to 15
   npx supabase db query "UPDATE user_health SET current_hp = 15;"

   # Refresh dashboard
   # Expected: Red "Kritischer HP-Stand" alert appears
   ```

6. **Test prestige flow:**
   ```bash
   # Set lives to 0
   npx supabase db query "UPDATE user_health SET lives = 0, awaiting_prestige = true;"

   # Visit dashboard
   # Expected: PrestigeModal appears automatically

   # Click "Phoenix-Prestige akzeptieren"
   # Expected:
   # - Lives reset to 3
   # - HP reset to 100
   # - Prestige level incremented
   # - Phoenix achievement granted
   # - Modal closes
   ```

7. **Check health events log:**
   ```bash
   npx supabase db query "SELECT * FROM health_events ORDER BY created_at DESC LIMIT 20;"
   # Expected: All HP changes logged with correct event_type
   ```

**Acceptance criteria:**
- [ ] All damage triggers work (quest fail, streak break, inactivity)
- [ ] All heal triggers work (quest complete, habit done, mood log)
- [ ] Death flow works (respawn, life loss, XP penalty, notification)
- [ ] Prestige flow works (modal, confirmation, reset, badge)
- [ ] HealthBar animates smoothly
- [ ] DangerZoneAlert appears at < 20 HP
- [ ] All HP changes logged to health_events
- [ ] No console errors or TypeScript errors
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
**End-to-end HP system checks:**

1. **Database integrity:**
```sql
-- Verify all tables and triggers exist
SELECT table_name FROM information_schema.tables
WHERE table_name IN ('user_health', 'health_events');

SELECT trigger_name FROM information_schema.triggers
WHERE trigger_name LIKE '%_hp_%';

-- Verify RPC functions
SELECT routine_name FROM information_schema.routines
WHERE routine_name = 'apply_hp_change';
```

2. **Component rendering:**
```bash
# Build check
npm run build

# No console errors on dashboard
npm run dev
# Visit localhost:3000/dashboard, open DevTools console
# Expected: No red errors
```

3. **Data flow verification:**
```typescript
// Test getUserHealth
import { getUserHealth, getHealthEvents } from '@/lib/data/health';

const health = await getUserHealth();
console.log('Health:', health);

const events = await getHealthEvents();
console.log('Recent events:', events.length);
```
</verification>

<success_criteria>
**Must be true after completion:**
- [ ] Prestige modal appears when lives = 0
- [ ] Prestige requires user confirmation
- [ ] Prestige grants Phoenix badge and resets HP/lives
- [ ] DangerZoneAlert appears when HP < 20
- [ ] All damage/heal triggers work
- [ ] Death flow applies XP loss
- [ ] HealthBar animates smoothly
- [ ] health_events logs all HP changes
- [ ] User verification passes (checkpoint approved)
</success_criteria>

<output>
After completion, create `.planning/phases/02-konsequenzen-hp-death/02-06-SUMMARY.md`
</output>
