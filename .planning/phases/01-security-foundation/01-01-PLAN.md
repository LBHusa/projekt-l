---
phase: 01-security-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/validation/index.ts
  - src/lib/validation/quest.ts
  - src/lib/validation/habit.ts
  - src/lib/validation/profile.ts
  - src/lib/validation/sanitize.ts
autonomous: true

must_haves:
  truths:
    - "Zod and isomorphic-dompurify are installed and available for import"
    - "Validation schemas exist for Quest, Habit, and Profile inputs"
    - "Sanitization utility strips HTML tags and XSS payloads from user input"
  artifacts:
    - path: "package.json"
      provides: "zod and isomorphic-dompurify dependencies"
      contains: "zod"
    - path: "src/lib/validation/index.ts"
      provides: "Barrel export for all validation schemas"
      exports: ["questCreateSchema", "habitCreateSchema", "profileUpdateSchema", "sanitizeHtml"]
    - path: "src/lib/validation/quest.ts"
      provides: "Quest input validation"
      exports: ["questCreateSchema", "questUpdateSchema", "QuestCreateInput", "QuestUpdateInput"]
    - path: "src/lib/validation/habit.ts"
      provides: "Habit input validation"
      exports: ["habitCreateSchema", "habitUpdateSchema", "HabitCreateInput", "HabitUpdateInput"]
    - path: "src/lib/validation/profile.ts"
      provides: "Profile input validation"
      exports: ["profileUpdateSchema", "ProfileUpdateInput"]
    - path: "src/lib/validation/sanitize.ts"
      provides: "XSS sanitization utility"
      exports: ["sanitizeHtml", "sanitizeText"]
  key_links:
    - from: "src/lib/validation/*.ts"
      to: "zod"
      via: "import { z } from 'zod'"
      pattern: "import.*from 'zod'"
    - from: "src/lib/validation/sanitize.ts"
      to: "isomorphic-dompurify"
      via: "import DOMPurify"
      pattern: "import.*DOMPurify.*from 'isomorphic-dompurify'"
---

<objective>
Install security validation dependencies (Zod v4, isomorphic-dompurify) and create input validation schemas for Quest, Habit, and Profile inputs.

Purpose: Establish the foundation for XSS prevention (SEC-05, SEC-06, SEC-07) by providing reusable validation schemas and sanitization utilities that will be integrated into API routes and forms.

Output: Installed dependencies in package.json, validation schemas in src/lib/validation/, and sanitization utilities ready for use.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-foundation/01-RESEARCH.md
@src/lib/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zod and isomorphic-dompurify</name>
  <files>package.json</files>
  <action>
    Run npm install to add security validation dependencies:
    ```bash
    npm install zod@^4.3.5 isomorphic-dompurify@^2.26.0
    ```

    Verify installation by checking package.json contains both dependencies.

    Note: jsdom is already installed (needed by isomorphic-dompurify for SSR).
  </action>
  <verify>`npm list zod isomorphic-dompurify` shows both packages installed</verify>
  <done>package.json contains zod@^4.x and isomorphic-dompurify@^2.26.x in dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create validation schemas for Quest, Habit, Profile</name>
  <files>
    src/lib/validation/index.ts
    src/lib/validation/quest.ts
    src/lib/validation/habit.ts
    src/lib/validation/profile.ts
  </files>
  <action>
    Create src/lib/validation/ directory and validation schema files.

    **quest.ts:**
    - `questCreateSchema`: title (string, 1-200 chars, no < >), description (string, max 2000, optional), xp_reward (number, 1-10000), skill_id (uuid), faction_id (uuid, optional), due_date (datetime, optional)
    - `questUpdateSchema`: All fields optional except id (uuid)
    - Export types: QuestCreateInput, QuestUpdateInput

    **habit.ts:**
    - `habitCreateSchema`: name (string, 1-100 chars, no < >), description (string, max 500, optional), icon (emoji, optional), xp_per_completion (number, 1-1000), frequency (enum: daily, weekly, custom), habit_type (enum: positive, negative), factions (array of {faction_id: uuid, weight: number 0-100})
    - `habitUpdateSchema`: All fields optional except id
    - Export types: HabitCreateInput, HabitUpdateInput

    **profile.ts:**
    - `profileUpdateSchema`: display_name (string, 2-50 chars, no < >), bio (string, max 500, optional), avatar_url (url, optional)
    - Export type: ProfileUpdateInput

    **index.ts:**
    - Barrel export all schemas and types from quest.ts, habit.ts, profile.ts, sanitize.ts

    Use Zod v4 syntax:
    - `z.string().min(1).max(200).trim().regex(/^[^<>]*$/, 'Cannot contain < or >')`
    - `z.number().int().min(1).max(10000)`
    - `z.string().uuid()`
    - `z.enum(['daily', 'weekly', 'custom'])`
  </action>
  <verify>`npx tsc --noEmit src/lib/validation/index.ts` compiles without errors</verify>
  <done>All validation schemas export correctly and TypeScript types are inferred from schemas</done>
</task>

<task type="auto">
  <name>Task 3: Create XSS sanitization utility</name>
  <files>src/lib/validation/sanitize.ts</files>
  <action>
    Create sanitization utility using isomorphic-dompurify:

    ```typescript
    import DOMPurify from 'isomorphic-dompurify';

    /**
     * Sanitize HTML content - allows basic formatting tags
     * Use for: Quest descriptions, Habit notes, Profile bios
     */
    export function sanitizeHtml(input: string | undefined | null): string {
      if (!input) return '';
      return DOMPurify.sanitize(input, {
        ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'br'],
        ALLOWED_ATTR: ['href'],
        ALLOW_DATA_ATTR: false,
      });
    }

    /**
     * Sanitize text - strips ALL HTML tags
     * Use for: Titles, names, single-line inputs
     */
    export function sanitizeText(input: string | undefined | null): string {
      if (!input) return '';
      return DOMPurify.sanitize(input, {
        ALLOWED_TAGS: [],
        ALLOWED_ATTR: [],
      });
    }

    /**
     * Check if input contains potentially dangerous content
     * Returns true if input is safe, false if suspicious
     */
    export function isSafeInput(input: string): boolean {
      const dangerous = /<script|javascript:|on\w+=/i;
      return !dangerous.test(input);
    }
    ```

    Export from index.ts barrel.
  </action>
  <verify>Import sanitize functions in a test file and verify they strip `<script>` tags</verify>
  <done>sanitizeHtml and sanitizeText functions work correctly and are exported from index.ts</done>
</task>

</tasks>

<verification>
1. `npm list zod isomorphic-dompurify` shows both packages
2. `npx tsc --noEmit` passes with no errors in validation files
3. Import test: `import { questCreateSchema, sanitizeHtml } from '@/lib/validation'` works
4. Schema test: `questCreateSchema.safeParse({ title: '<script>alert(1)</script>' })` returns success: false
5. Sanitize test: `sanitizeText('<script>alert(1)</script>')` returns empty string
</verification>

<success_criteria>
- Zod 4.x and isomorphic-dompurify 2.26+ installed in package.json
- src/lib/validation/index.ts exports all schemas and utilities
- Quest, Habit, Profile schemas reject inputs containing < or >
- sanitizeHtml strips script tags but allows b, i, em, strong, a, br
- sanitizeText strips ALL HTML tags
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation/01-01-SUMMARY.md`
</output>
