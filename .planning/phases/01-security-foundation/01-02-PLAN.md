---
phase: 01-security-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260122_001_rls_verification_and_indexes.sql
autonomous: true

must_haves:
  truths:
    - "User querying habits table only sees their own habits (RLS enforced)"
    - "User querying quests table only sees their own quests (RLS enforced)"
    - "All 49 RLS-protected tables have user_id BTREE indexes for performance"
  artifacts:
    - path: "supabase/migrations/20260122_001_rls_verification_and_indexes.sql"
      provides: "RLS verification assertions and performance indexes"
      contains: "CREATE INDEX CONCURRENTLY"
      min_lines: 80
  key_links:
    - from: "supabase/migrations/20260122_001_rls_verification_and_indexes.sql"
      to: "existing RLS policies in 20260116_rls_policies.sql"
      via: "verification queries and indexes on user_id columns"
      pattern: "idx_.*_user_id"
---

<objective>
Verify RLS policies are enabled on all 49 tables, then create performance indexes for RLS-protected tables.

Purpose: Address SEC-03 (RLS enforcement) by first verifying all tables have RLS enabled, then creating BTREE indexes on user_id columns to prevent 100x+ performance degradation. This migration MUST verify RLS before creating indexes.

Output: SQL migration file that first asserts RLS is enabled on all tables, then creates performance indexes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-foundation/01-RESEARCH.md
@supabase/migrations/20260116_rls_policies.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RLS verification and indexes migration</name>
  <files>supabase/migrations/20260122_001_rls_verification_and_indexes.sql</files>
  <action>
    Create migration file that FIRST verifies RLS is enabled on all 49 tables, THEN creates indexes.

    **Part 1: RLS Verification (MUST run first)**
    ```sql
    -- ============================================
    -- PART 1: VERIFY RLS IS ENABLED ON ALL TABLES
    -- This migration will FAIL if RLS is not enabled
    -- ============================================

    DO $$
    DECLARE
      tables_without_rls TEXT[];
      table_record RECORD;
    BEGIN
      -- Get list of tables that should have RLS but don't
      SELECT array_agg(tablename)
      INTO tables_without_rls
      FROM pg_tables t
      LEFT JOIN pg_class c ON c.relname = t.tablename
      WHERE t.schemaname = 'public'
        AND t.tablename IN (
          'accounts', 'activity_log', 'ai_faction_suggestions_feedback', 'body_metrics',
          'books', 'budgets', 'career_goals', 'career_sources', 'contact_interactions',
          'contacts', 'courses', 'experiences', 'finance_achievements', 'finance_streaks',
          'google_calendar_integrations', 'habit_logs', 'habit_reminders', 'habits',
          'health_import_logs', 'hobby_projects', 'hobby_time_logs', 'investments',
          'job_history', 'journal_entries', 'mental_stats_logs', 'mood_logs',
          'net_worth_history', 'notification_log', 'notification_settings', 'notion_integrations',
          'quest_actions', 'quests', 'recurring_flows', 'reminder_delivery_log',
          'salary_entries', 'savings_goals', 'sleep_logs', 'social_events',
          'training_plans', 'transaction_categories', 'transactions', 'user_achievements',
          'user_api_keys', 'user_faction_stats', 'user_profiles', 'user_quest_preferences',
          'user_skills', 'workout_sessions', 'workouts'
        )
        AND NOT c.relrowsecurity;

      -- Fail migration if any tables lack RLS
      IF array_length(tables_without_rls, 1) > 0 THEN
        RAISE EXCEPTION 'RLS not enabled on tables: %. Enable RLS before running this migration.',
          array_to_string(tables_without_rls, ', ');
      END IF;

      RAISE NOTICE 'RLS verification passed: all 49 tables have RLS enabled';
    END $$;

    -- Verify RLS policies exist (not just enabled)
    DO $$
    DECLARE
      tables_without_policies TEXT[];
    BEGIN
      SELECT array_agg(DISTINCT t.tablename)
      INTO tables_without_policies
      FROM pg_tables t
      WHERE t.schemaname = 'public'
        AND t.tablename IN (
          'habits', 'quests', 'user_skills', 'user_faction_stats',
          'journal_entries', 'contacts', 'mood_logs'  -- Critical user-data tables
        )
        AND NOT EXISTS (
          SELECT 1 FROM pg_policies p
          WHERE p.tablename = t.tablename
            AND p.schemaname = 'public'
        );

      IF array_length(tables_without_policies, 1) > 0 THEN
        RAISE EXCEPTION 'Tables have RLS enabled but no policies defined: %. Create policies before running this migration.',
          array_to_string(tables_without_policies, ', ');
      END IF;

      RAISE NOTICE 'RLS policy verification passed: critical tables have policies defined';
    END $$;
    ```

    **Part 2: Performance Indexes (after RLS verified)**
    ```sql
    -- ============================================
    -- PART 2: CREATE PERFORMANCE INDEXES
    -- Only runs if Part 1 passed
    -- ============================================

    -- Note: Using CONCURRENTLY requires running outside transaction
    -- If running via Supabase Dashboard, run each CREATE INDEX separately

    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_accounts_user_id ON accounts USING btree (user_id);
    CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_activity_log_user_id ON activity_log USING btree (user_id);
    -- ... (all 49 tables)
    ```

    Tables requiring indexes (from existing RLS migration):
    - accounts, activity_log, ai_faction_suggestions_feedback, body_metrics
    - books, budgets, career_goals, career_sources, contact_interactions
    - contacts, courses, experiences, finance_achievements, finance_streaks
    - google_calendar_integrations, habit_logs, habit_reminders, habits
    - health_import_logs, hobby_projects, hobby_time_logs, investments
    - job_history, journal_entries, mental_stats_logs, mood_logs
    - net_worth_history, notification_log, notification_settings, notion_integrations
    - quest_actions, quests, recurring_flows, reminder_delivery_log
    - salary_entries, savings_goals, sleep_logs, social_events
    - training_plans, transaction_categories, transactions, user_achievements
    - user_api_keys, user_faction_stats, user_profiles, user_quest_preferences
    - user_skills, workout_sessions, workouts

    Also add composite indexes:
    - `idx_quests_user_status ON quests(user_id, status)`
    - `idx_habits_user_active ON habits(user_id, is_active)`
    - `idx_habit_logs_user_date ON habit_logs(user_id, logged_at)`
  </action>
  <verify>SQL syntax is valid and RLS verification DO blocks execute correctly</verify>
  <done>Migration file exists with RLS verification first, then indexes for all 49 tables</done>
</task>

<task type="auto">
  <name>Task 2: Add RLS cross-user prevention test queries</name>
  <files>supabase/migrations/20260122_001_rls_verification_and_indexes.sql</files>
  <action>
    Add test queries at the end of the migration (as comments) that verify RLS prevents cross-user data access:

    ```sql
    -- ============================================
    -- SEC-03 VERIFICATION QUERIES
    -- Run these after migration to verify RLS prevents cross-user access
    -- ============================================

    -- Test 1: Verify User A cannot see User B's habits
    -- SET ROLE authenticated;
    -- SET request.jwt.claims = '{"sub": "user-a-uuid"}';
    -- SELECT * FROM habits WHERE user_id = 'user-b-uuid';
    -- Expected: 0 rows (RLS blocks cross-user access)

    -- Test 2: Verify User A cannot see User B's quests
    -- SET request.jwt.claims = '{"sub": "user-a-uuid"}';
    -- SELECT * FROM quests WHERE user_id = 'user-b-uuid';
    -- Expected: 0 rows

    -- Test 3: Verify User A cannot see User B's journal entries
    -- SELECT * FROM journal_entries WHERE user_id = 'user-b-uuid';
    -- Expected: 0 rows

    -- Test 4: Check all indexes exist
    -- SELECT indexname, tablename FROM pg_indexes
    -- WHERE schemaname = 'public' AND indexname LIKE 'idx_%_user_id'
    -- ORDER BY tablename;
    -- Expected: 49+ rows

    -- Test 5: Verify Index Scan is used (not Seq Scan)
    -- EXPLAIN ANALYZE SELECT * FROM habits WHERE user_id = 'your-uuid';
    -- Expected: "Index Scan using idx_habits_user_id"

    -- ============================================
    -- RLS POLICY OPTIMIZATION NOTE
    -- ============================================
    -- For optimal performance, RLS policies should use:
    --   USING ((SELECT auth.uid()) = user_id)
    -- Instead of:
    --   USING (auth.uid() = user_id)
    -- The SELECT wrapper caches the auth.uid() call.
    ```
  </action>
  <verify>Migration file contains SEC-03 verification queries in comments</verify>
  <done>Migration includes RLS cross-user test queries for SEC-03 verification</done>
</task>

</tasks>

<verification>
1. Migration file exists at correct path
2. Migration FAILS if RLS is not enabled (tested by temporarily disabling RLS on a test table)
3. All 49 tables from RLS migration have corresponding indexes
4. All indexes use `CREATE INDEX CONCURRENTLY IF NOT EXISTS`
5. Composite indexes exist for quests, habits, habit_logs
6. SQL syntax is valid (no syntax errors)
7. SEC-03 verification queries are included in comments
</verification>

<success_criteria>
- Migration verifies RLS is enabled BEFORE creating indexes
- Migration fails with clear error if RLS is missing on any table
- Creates 49+ indexes (one per RLS table + composites)
- Uses CONCURRENTLY to avoid table locks
- Uses IF NOT EXISTS for idempotency
- Includes SEC-03 verification queries for testing cross-user data access
- Ready to apply via `supabase db push` or SQL editor
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation/01-02-SUMMARY.md`
</output>
