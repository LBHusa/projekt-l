---
phase: 01-security-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/app/api/geist/stats/route.ts
  - src/app/api/contacts/create/route.ts
  - src/app/api/test/mood-logs/route.ts
  - src/app/api/test/journal-entries/route.ts
  - src/hooks/use-faction-suggestion.ts
autonomous: true

must_haves:
  truths:
    - "No hardcoded user UUIDs remain in API routes"
    - "API routes return 401 Unauthorized when user not authenticated"
    - "Test routes either require auth or are clearly marked as dev-only"
  artifacts:
    - path: "src/app/api/geist/stats/route.ts"
      provides: "Geist stats API with proper auth"
      contains: "supabase.auth.getUser()"
    - path: "src/app/api/contacts/create/route.ts"
      provides: "Contact creation API with auth and domain lookup"
      contains: "supabase.auth.getUser()"
    - path: "src/hooks/use-faction-suggestion.ts"
      provides: "Faction suggestion hook using real auth"
      contains: "useAuth"
  key_links:
    - from: "src/app/api/*/route.ts"
      to: "supabase.auth.getUser()"
      via: "authentication check"
      pattern: "const.*user.*=.*await.*getUser"
    - from: "src/hooks/use-faction-suggestion.ts"
      to: "@/hooks/useAuth"
      via: "useAuth hook"
      pattern: "import.*useAuth.*from"
---

<objective>
Remove hardcoded user UUIDs from API routes and hooks, replacing them with proper authentication.

Purpose: Address SEC-01 and SEC-02 by eliminating fallback UUIDs that could expose one user's data to all users. API routes must authenticate users and reject unauthenticated requests with 401.

Output: All API routes use supabase.auth.getUser() instead of hardcoded UUIDs, and hooks use useAuth() hook.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-foundation/01-RESEARCH.md
@src/lib/auth-helper.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix geist/stats API route authentication</name>
  <files>src/app/api/geist/stats/route.ts</files>
  <action>
    Current code has:
    ```typescript
    const userId = searchParams.get("userId") || "00000000-0000-0000-0000-000000000001";
    ```

    Replace with proper authentication:
    ```typescript
    import { createClient } from '@/lib/supabase/server';
    import { NextRequest, NextResponse } from 'next/server';

    export async function GET(request: NextRequest) {
      const supabase = await createClient();
      const { data: { user }, error: authError } = await supabase.auth.getUser();

      if (authError || !user) {
        return NextResponse.json(
          { error: 'Unauthorized' },
          { status: 401 }
        );
      }

      const userId = user.id;
      // ... rest of route logic using userId
    }
    ```

    Remove the hardcoded fallback UUID entirely. Unauthenticated requests should receive 401, not default data.
  </action>
  <verify>Grep for hardcoded UUID pattern returns no matches in this file</verify>
  <done>geist/stats route authenticates user and returns 401 for unauthenticated requests</done>
</task>

<task type="auto">
  <name>Task 2: Fix contacts/create API route - auth and domain lookup</name>
  <files>src/app/api/contacts/create/route.ts</files>
  <action>
    Current code has hardcoded domain IDs:
    ```typescript
    return '77777777-7777-7777-7777-777777777777'; // Familie Domain
    return 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa'; // Soziales Domain
    return '66666666-6666-6666-6666-666666666666'; // Karriere Domain
    ```

    Replace with:
    1. Proper authentication (getUser, 401 on fail)
    2. Database lookup for domain IDs by name:

    ```typescript
    // Helper function to get domain ID by name
    async function getDomainIdByName(
      supabase: SupabaseClient,
      domainName: string
    ): Promise<string | null> {
      const { data } = await supabase
        .from('life_domains')
        .select('id')
        .eq('name', domainName)
        .single();
      return data?.id ?? null;
    }

    // In route handler:
    const supabase = await createClient();
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // Get domain ID dynamically
    let domainId: string | null = null;
    if (category === 'family') {
      domainId = await getDomainIdByName(supabase, 'Familie');
    } else if (category === 'friend') {
      domainId = await getDomainIdByName(supabase, 'Soziales');
    } else if (category === 'colleague') {
      domainId = await getDomainIdByName(supabase, 'Karriere');
    }
    ```

    Remove ALL hardcoded UUIDs from this file.
  </action>
  <verify>Grep for UUID pattern (8-4-4-4-12) returns no matches in this file</verify>
  <done>contacts/create uses database lookup for domain IDs, no hardcoded UUIDs</done>
</task>

<task type="auto">
  <name>Task 3: Fix test routes and use-faction-suggestion hook</name>
  <files>
    src/app/api/test/mood-logs/route.ts
    src/app/api/test/journal-entries/route.ts
    src/hooks/use-faction-suggestion.ts
  </files>
  <action>
    **Test routes (mood-logs, journal-entries):**
    Option A: Add authentication (same pattern as geist/stats)
    Option B: Rename to clearly indicate dev-only and add environment check

    Choose Option B for test routes - they're debug tools:
    ```typescript
    export async function GET(request: NextRequest) {
      // Only allow in development
      if (process.env.NODE_ENV === 'production') {
        return NextResponse.json(
          { error: 'Test endpoint not available in production' },
          { status: 404 }
        );
      }

      // Still require auth even in dev
      const supabase = await createClient();
      const { data: { user }, error } = await supabase.auth.getUser();

      if (error || !user) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
      }

      const userId = user.id;
      // ... rest of test logic
    }
    ```

    **use-faction-suggestion.ts:**
    Current code has:
    ```typescript
    const TEST_USER_ID = '00000000-0000-0000-0000-000000000001';
    ```

    Replace with useAuth hook:
    ```typescript
    import { useAuth } from '@/hooks/useAuth';

    export function useFactionSuggestion() {
      const { userId, loading: authLoading } = useAuth();

      // If not authenticated, return early
      if (authLoading || !userId) {
        return { /* default empty state */ };
      }

      // Use userId from auth instead of TEST_USER_ID
      // ... rest of hook logic
    }
    ```

    Remove the TEST_USER_ID constant entirely.
  </action>
  <verify>Grep for "00000000-0000-0000-0000-000000000001" returns no matches in src/</verify>
  <done>Test routes are dev-only with auth, hook uses useAuth instead of hardcoded ID</done>
</task>

</tasks>

<verification>
1. `grep -r "00000000-0000-0000-0000-000000000001" src/` returns no matches
2. `grep -r "77777777-7777-7777-7777-777777777777" src/app/api/` returns no matches
3. All modified API routes have `supabase.auth.getUser()` call
4. All modified API routes return 401 for unauthenticated requests
5. use-faction-suggestion.ts imports and uses useAuth hook
6. `npx tsc --noEmit` passes with no errors
</verification>

<success_criteria>
- No hardcoded user UUIDs (00000000-...) in src/ directory
- No hardcoded domain UUIDs in API routes (database lookup instead)
- API routes return 401 Unauthorized for unauthenticated requests
- Test routes are disabled in production environment
- use-faction-suggestion hook uses useAuth() instead of TEST_USER_ID
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-foundation/01-03-SUMMARY.md`
</output>
