---
phase: 01-fairness-proaktivitaet
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260201_streak_insurance_tokens.sql
  - src/lib/types/streak-insurance.ts
  - src/lib/data/streak-insurance.ts
  - src/app/api/streak-insurance/tokens/route.ts
  - src/app/api/streak-insurance/use/route.ts
  - src/components/streaks/StreakInsuranceCard.tsx
  - src/components/streaks/UseTokenModal.tsx
  - src/components/streaks/index.ts
  - src/lib/database.types.ts
autonomous: true

must_haves:
  truths:
    - "User can see their available streak insurance tokens on dashboard"
    - "User can use a token to protect a streak that would otherwise break"
    - "Tokens expire after 30 days and are consumed on use"
    - "Token usage is logged with habit reference"
  artifacts:
    - path: "supabase/migrations/20260201_streak_insurance_tokens.sql"
      provides: "Database schema for streak tokens"
      contains: "CREATE TABLE streak_insurance_tokens"
    - path: "src/lib/data/streak-insurance.ts"
      provides: "CRUD operations for streak tokens"
      exports: ["getAvailableTokens", "useToken", "grantToken"]
    - path: "src/app/api/streak-insurance/tokens/route.ts"
      provides: "API endpoint to list tokens"
      exports: ["GET"]
    - path: "src/app/api/streak-insurance/use/route.ts"
      provides: "API endpoint to use token"
      exports: ["POST"]
    - path: "src/components/streaks/StreakInsuranceCard.tsx"
      provides: "Dashboard widget showing token count"
      min_lines: 40
  key_links:
    - from: "src/components/streaks/StreakInsuranceCard.tsx"
      to: "/api/streak-insurance/tokens"
      via: "fetch in useEffect"
      pattern: "fetch.*api/streak-insurance/tokens"
    - from: "src/app/api/streak-insurance/use/route.ts"
      to: "streak_insurance_tokens"
      via: "supabase update"
      pattern: "supabase.*from.*streak_insurance_tokens.*update"
---

<objective>
Implement the Streak Insurance Token System that allows users to protect their habit streaks from breaking.

Purpose: Prevent frustration from accidental streak breaks. Users earn tokens (login bonus, achievements) and can use them to preserve streaks when they miss a day. This makes the gamification "fair" by providing a safety net.

Output:
- Database table for token storage
- API endpoints for listing and using tokens
- UI components for dashboard display and token usage modal
</objective>

<execution_context>
@/root/.claude/get-shit-done/workflows/execute-plan.md
@/root/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-fairness-proaktivitaet/01-RESEARCH.md

Key existing patterns:
- Database types in `src/lib/database.types.ts`
- Data layer pattern in `src/lib/data/habits.ts`
- API route pattern in `src/app/api/habits/complete/route.ts`
- Component pattern in `src/components/dashboard/`
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for streak_insurance_tokens</name>
  <files>supabase/migrations/20260201_streak_insurance_tokens.sql</files>
  <action>
Create migration file with:

```sql
-- Streak Insurance Tokens
-- Allows users to protect streaks from breaking

CREATE TABLE IF NOT EXISTS streak_insurance_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,

  -- Token info
  token_type TEXT NOT NULL DEFAULT 'standard' CHECK (token_type IN ('standard', 'premium')),
  reason TEXT NOT NULL CHECK (reason IN ('login_bonus', 'achievement', 'purchase', 'trial_bonus')),

  -- Usage tracking
  is_used BOOLEAN DEFAULT FALSE,
  used_at TIMESTAMPTZ,
  used_for_habit_id UUID REFERENCES habits(id) ON DELETE SET NULL,

  -- Validity
  expires_at TIMESTAMPTZ DEFAULT (NOW() + INTERVAL '30 days'),

  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Index for fast lookup of available tokens
CREATE INDEX idx_streak_tokens_user ON streak_insurance_tokens(user_id);
CREATE INDEX idx_streak_tokens_available ON streak_insurance_tokens(user_id)
  WHERE is_used = FALSE AND expires_at > NOW();

-- RLS policies
ALTER TABLE streak_insurance_tokens ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own tokens" ON streak_insurance_tokens
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can update own tokens" ON streak_insurance_tokens
  FOR UPDATE USING (auth.uid() = user_id);

-- System can insert tokens (via service role)
CREATE POLICY "Service can insert tokens" ON streak_insurance_tokens
  FOR INSERT WITH CHECK (true);

COMMENT ON TABLE streak_insurance_tokens IS 'Tokens that protect habit streaks from breaking';
```

Run migration locally if Supabase CLI available, otherwise note for manual execution.
  </action>
  <verify>
Check migration file exists and has valid SQL syntax:
```bash
cat supabase/migrations/20260201_streak_insurance_tokens.sql
```
Validate with `npx supabase db lint` if available.
  </verify>
  <done>Migration file exists with correct schema including RLS policies and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create types and data layer for streak insurance</name>
  <files>
    src/lib/types/streak-insurance.ts
    src/lib/data/streak-insurance.ts
    src/lib/database.types.ts
  </files>
  <action>
Create type definitions in `src/lib/types/streak-insurance.ts`:

```typescript
// ============================================
// Streak Insurance Token Types
// ============================================

export type TokenType = 'standard' | 'premium';
export type TokenReason = 'login_bonus' | 'achievement' | 'purchase' | 'trial_bonus';

export interface StreakInsuranceToken {
  id: string;
  user_id: string;
  token_type: TokenType;
  reason: TokenReason;
  is_used: boolean;
  used_at: string | null;
  used_for_habit_id: string | null;
  expires_at: string;
  created_at: string;
}

export interface UseTokenResult {
  success: boolean;
  token?: StreakInsuranceToken;
  error?: string;
}

export interface TokenStats {
  available: number;
  used: number;
  expired: number;
}
```

Create data layer in `src/lib/data/streak-insurance.ts`:

```typescript
// ============================================
// Streak Insurance Token Data Layer
// ============================================

import { createBrowserClient } from '@/lib/supabase';
import { getUserIdOrCurrent } from '@/lib/auth-helper';
import type {
  StreakInsuranceToken,
  UseTokenResult,
  TokenStats,
  TokenReason
} from '@/lib/types/streak-insurance';

/**
 * Get all available (unused, not expired) tokens for current user
 */
export async function getAvailableTokens(userId?: string): Promise<StreakInsuranceToken[]> {
  const resolvedUserId = await getUserIdOrCurrent(userId);
  const supabase = createBrowserClient();

  const { data, error } = await supabase
    .from('streak_insurance_tokens')
    .select('*')
    .eq('user_id', resolvedUserId)
    .eq('is_used', false)
    .gt('expires_at', new Date().toISOString())
    .order('expires_at', { ascending: true });

  if (error) {
    console.error('Error fetching streak tokens:', error);
    throw error;
  }

  return data || [];
}

/**
 * Get token statistics for current user
 */
export async function getTokenStats(userId?: string): Promise<TokenStats> {
  const resolvedUserId = await getUserIdOrCurrent(userId);
  const supabase = createBrowserClient();

  const now = new Date().toISOString();

  // Get all tokens to calculate stats
  const { data, error } = await supabase
    .from('streak_insurance_tokens')
    .select('is_used, expires_at')
    .eq('user_id', resolvedUserId);

  if (error) {
    console.error('Error fetching token stats:', error);
    throw error;
  }

  const tokens = data || [];

  return {
    available: tokens.filter(t => !t.is_used && t.expires_at > now).length,
    used: tokens.filter(t => t.is_used).length,
    expired: tokens.filter(t => !t.is_used && t.expires_at <= now).length,
  };
}

/**
 * Use a token to protect a streak
 * Returns the used token or error if none available
 */
export async function useToken(habitId: string, userId?: string): Promise<UseTokenResult> {
  const resolvedUserId = await getUserIdOrCurrent(userId);
  const supabase = createBrowserClient();

  // Find and use the oldest available token (FIFO)
  const { data: token, error } = await supabase
    .from('streak_insurance_tokens')
    .update({
      is_used: true,
      used_at: new Date().toISOString(),
      used_for_habit_id: habitId,
    })
    .eq('user_id', resolvedUserId)
    .eq('is_used', false)
    .gt('expires_at', new Date().toISOString())
    .order('expires_at', { ascending: true })
    .limit(1)
    .select()
    .single();

  if (error) {
    if (error.code === 'PGRST116') {
      return { success: false, error: 'No tokens available' };
    }
    console.error('Error using streak token:', error);
    return { success: false, error: error.message };
  }

  return { success: true, token };
}

/**
 * Grant a new token to user (called by system/API)
 */
export async function grantToken(
  userId: string,
  reason: TokenReason,
  tokenType: 'standard' | 'premium' = 'standard',
  expiresInDays: number = 30
): Promise<StreakInsuranceToken> {
  const supabase = createBrowserClient();

  const expiresAt = new Date();
  expiresAt.setDate(expiresAt.getDate() + expiresInDays);

  const { data, error } = await supabase
    .from('streak_insurance_tokens')
    .insert({
      user_id: userId,
      token_type: tokenType,
      reason,
      expires_at: expiresAt.toISOString(),
    })
    .select()
    .single();

  if (error) {
    console.error('Error granting streak token:', error);
    throw error;
  }

  return data;
}
```

Add type to database.types.ts exports section (near bottom of file):

```typescript
// Streak Insurance Types
export type {
  StreakInsuranceToken,
  UseTokenResult,
  TokenStats,
  TokenType,
  TokenReason
} from '@/lib/types/streak-insurance';
```
  </action>
  <verify>
```bash
# Check files exist
ls -la src/lib/types/streak-insurance.ts src/lib/data/streak-insurance.ts

# TypeScript compilation check
npm run build 2>&1 | head -50
```
  </verify>
  <done>Type definitions and data layer functions compile without errors</done>
</task>

<task type="auto">
  <name>Task 3: Create API endpoints for streak insurance</name>
  <files>
    src/app/api/streak-insurance/tokens/route.ts
    src/app/api/streak-insurance/use/route.ts
  </files>
  <action>
Create `src/app/api/streak-insurance/tokens/route.ts`:

```typescript
// ============================================
// Streak Insurance Tokens API
// GET /api/streak-insurance/tokens
// ============================================

import { NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { getAvailableTokens, getTokenStats } from '@/lib/data/streak-insurance';

export async function GET() {
  try {
    const supabase = await createClient();
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    const [tokens, stats] = await Promise.all([
      getAvailableTokens(user.id),
      getTokenStats(user.id),
    ]);

    return NextResponse.json({
      tokens,
      stats,
    });
  } catch (error) {
    console.error('[Streak Insurance API] Error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```

Create `src/app/api/streak-insurance/use/route.ts`:

```typescript
// ============================================
// Use Streak Insurance Token API
// POST /api/streak-insurance/use
// ============================================

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { useToken } from '@/lib/data/streak-insurance';

export async function POST(request: NextRequest) {
  try {
    const supabase = await createClient();
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
      return NextResponse.json(
        { error: 'Unauthorized' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const { habitId } = body;

    if (!habitId) {
      return NextResponse.json(
        { error: 'habitId is required' },
        { status: 400 }
      );
    }

    // Verify habit belongs to user
    const { data: habit, error: habitError } = await supabase
      .from('habits')
      .select('id, name')
      .eq('id', habitId)
      .eq('user_id', user.id)
      .single();

    if (habitError || !habit) {
      return NextResponse.json(
        { error: 'Habit not found' },
        { status: 404 }
      );
    }

    const result = await useToken(habitId, user.id);

    if (!result.success) {
      return NextResponse.json(
        { error: result.error || 'Failed to use token' },
        { status: 400 }
      );
    }

    return NextResponse.json({
      success: true,
      token: result.token,
      message: `Streak protected for "${habit.name}"`,
    });
  } catch (error) {
    console.error('[Streak Insurance Use API] Error:', error);
    return NextResponse.json(
      { error: 'Internal server error' },
      { status: 500 }
    );
  }
}
```
  </action>
  <verify>
```bash
# Check files exist
ls -la src/app/api/streak-insurance/*/route.ts

# Build check
npm run build 2>&1 | head -50
```
  </verify>
  <done>API endpoints compile and follow existing route patterns</done>
</task>

<task type="auto">
  <name>Task 4: Create UI components for streak insurance</name>
  <files>
    src/components/streaks/StreakInsuranceCard.tsx
    src/components/streaks/UseTokenModal.tsx
    src/components/streaks/index.ts
  </files>
  <action>
Create directory and index file `src/components/streaks/index.ts`:

```typescript
export { StreakInsuranceCard } from './StreakInsuranceCard';
export { UseTokenModal } from './UseTokenModal';
```

Create `src/components/streaks/StreakInsuranceCard.tsx`:

```typescript
'use client';

import { useState, useEffect } from 'react';
import { Shield, ChevronRight, Loader2 } from 'lucide-react';
import type { TokenStats } from '@/lib/types/streak-insurance';

interface StreakInsuranceCardProps {
  className?: string;
  onViewDetails?: () => void;
}

export function StreakInsuranceCard({ className = '', onViewDetails }: StreakInsuranceCardProps) {
  const [stats, setStats] = useState<TokenStats | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    fetchTokenStats();
  }, []);

  async function fetchTokenStats() {
    try {
      setLoading(true);
      const response = await fetch('/api/streak-insurance/tokens');

      if (!response.ok) {
        throw new Error('Failed to fetch tokens');
      }

      const data = await response.json();
      setStats(data.stats);
    } catch (err) {
      console.error('Error fetching token stats:', err);
      setError('Konnte Tokens nicht laden');
    } finally {
      setLoading(false);
    }
  }

  if (loading) {
    return (
      <div className={`bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm ${className}`}>
        <div className="flex items-center justify-center py-4">
          <Loader2 className="w-5 h-5 animate-spin text-gray-400" />
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className={`bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm ${className}`}>
        <p className="text-sm text-red-500">{error}</p>
      </div>
    );
  }

  const tokenCount = stats?.available || 0;

  return (
    <div
      className={`bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 rounded-xl p-4 shadow-sm cursor-pointer hover:shadow-md transition-shadow ${className}`}
      onClick={onViewDetails}
    >
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-purple-100 dark:bg-purple-800/50 rounded-lg">
            <Shield className="w-5 h-5 text-purple-600 dark:text-purple-400" />
          </div>
          <div>
            <h3 className="font-medium text-gray-900 dark:text-white">
              Streak-Schutz
            </h3>
            <p className="text-sm text-gray-500 dark:text-gray-400">
              {tokenCount === 0
                ? 'Keine Tokens verfuegbar'
                : `${tokenCount} Token${tokenCount !== 1 ? 's' : ''} verfuegbar`
              }
            </p>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <span className="text-2xl font-bold text-purple-600 dark:text-purple-400">
            {tokenCount}
          </span>
          {onViewDetails && (
            <ChevronRight className="w-5 h-5 text-gray-400" />
          )}
        </div>
      </div>

      {tokenCount > 0 && (
        <p className="mt-3 text-xs text-gray-500 dark:text-gray-400">
          Schuetzt deine Streaks vor dem Brechen
        </p>
      )}
    </div>
  );
}
```

Create `src/components/streaks/UseTokenModal.tsx`:

```typescript
'use client';

import { useState } from 'react';
import { Shield, AlertTriangle, X, Loader2 } from 'lucide-react';

interface UseTokenModalProps {
  isOpen: boolean;
  onClose: () => void;
  habitId: string;
  habitName: string;
  currentStreak: number;
  onTokenUsed: () => void;
}

export function UseTokenModal({
  isOpen,
  onClose,
  habitId,
  habitName,
  currentStreak,
  onTokenUsed,
}: UseTokenModalProps) {
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  if (!isOpen) return null;

  async function handleUseToken() {
    try {
      setLoading(true);
      setError(null);

      const response = await fetch('/api/streak-insurance/use', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ habitId }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Failed to use token');
      }

      onTokenUsed();
      onClose();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Ein Fehler ist aufgetreten');
    } finally {
      setLoading(false);
    }
  }

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
      <div className="bg-white dark:bg-gray-800 rounded-2xl max-w-md w-full p-6 shadow-xl">
        {/* Header */}
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-yellow-100 dark:bg-yellow-900/30 rounded-lg">
              <AlertTriangle className="w-5 h-5 text-yellow-600" />
            </div>
            <h2 className="text-lg font-semibold text-gray-900 dark:text-white">
              Streak in Gefahr!
            </h2>
          </div>
          <button
            onClick={onClose}
            className="p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"
          >
            <X className="w-5 h-5 text-gray-500" />
          </button>
        </div>

        {/* Content */}
        <div className="mb-6">
          <p className="text-gray-600 dark:text-gray-300 mb-4">
            Dein <strong>{currentStreak}-Tage-Streak</strong> fuer{' '}
            <strong>"{habitName}"</strong> wuerde heute brechen.
          </p>

          <div className="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 flex items-center gap-3">
            <Shield className="w-8 h-8 text-purple-600 flex-shrink-0" />
            <div>
              <p className="font-medium text-purple-900 dark:text-purple-100">
                Streak-Schutz verwenden?
              </p>
              <p className="text-sm text-purple-700 dark:text-purple-300">
                1 Token schuetzt deinen Streak fuer heute
              </p>
            </div>
          </div>
        </div>

        {error && (
          <div className="mb-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg">
            <p className="text-sm text-red-600 dark:text-red-400">{error}</p>
          </div>
        )}

        {/* Actions */}
        <div className="flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700"
          >
            Streak brechen lassen
          </button>
          <button
            onClick={handleUseToken}
            disabled={loading}
            className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 flex items-center justify-center gap-2"
          >
            {loading ? (
              <Loader2 className="w-4 h-4 animate-spin" />
            ) : (
              <>
                <Shield className="w-4 h-4" />
                Token verwenden
              </>
            )}
          </button>
        </div>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
```bash
# Check files exist
ls -la src/components/streaks/

# Build check
npm run build 2>&1 | head -50
```
  </verify>
  <done>UI components compile and follow existing component patterns</done>
</task>

<task type="auto">
  <name>Task 5: Integrate StreakInsuranceCard into dashboard</name>
  <files>src/app/(protected)/dashboard/page.tsx</files>
  <action>
Import and add the StreakInsuranceCard component to the dashboard page.

1. Add import at top of file:
```typescript
import { StreakInsuranceCard } from '@/components/streaks';
```

2. Add the component to the dashboard layout (in the sidebar/stats area alongside existing cards like habit summary, XP display, or faction overview):
```typescript
<StreakInsuranceCard
  className="mt-4"
  onViewDetails={() => {/* Optional: navigate to detailed view */}}
/>
```

Place the component in a logical position - ideally in the right sidebar or stats section where users can quickly see their available tokens. The exact placement depends on existing dashboard layout, but it should be visible on the main dashboard view.
  </action>
  <verify>
```bash
# Check import was added
grep -n "StreakInsuranceCard" src/app/\(protected\)/dashboard/page.tsx

# Build check
npm run build 2>&1 | head -30
```
  </verify>
  <done>StreakInsuranceCard is rendered on the dashboard page and visible to users</done>
</task>

</tasks>

<verification>
1. All files created and TypeScript compiles: `npm run build`
2. Database migration has valid SQL syntax
3. API endpoints follow authentication pattern (check auth before operations)
4. Components use existing patterns (Tailwind, Lucide icons, dark mode support)
5. Data layer uses `createBrowserClient` and `getUserIdOrCurrent` pattern
6. StreakInsuranceCard is imported and rendered in dashboard page
</verification>

<success_criteria>
- [ ] Database migration file exists with streak_insurance_tokens table
- [ ] TypeScript types defined for StreakInsuranceToken
- [ ] Data layer provides getAvailableTokens, useToken, grantToken functions
- [ ] GET /api/streak-insurance/tokens returns user's tokens
- [ ] POST /api/streak-insurance/use consumes a token for a habit
- [ ] StreakInsuranceCard component displays token count
- [ ] UseTokenModal allows using a token with confirmation
- [ ] StreakInsuranceCard is rendered on the dashboard page
- [ ] All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-fairness-proaktivitaet/01-01-SUMMARY.md`
</output>
